<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Productos en Venta</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/products.css" />
  </head>
  <body>
    <!-- Navbar -->
    <div class="navbar">
      <a href="/loanForm.html">Solicitud de Préstamo</a>
      <a href="/solicitudes.html">Lista de Solicitudes</a>
      <a href="/payments.html">Realización de Pagos</a>
      <a href="/productos.html">Productos en Venta</a>
      <a href="#" onclick="cerrarSesion()">Cerrar sesión</a>
    </div>

    <h1>Productos en Venta</h1>


    <!-- Filtros por categoría -->
    <div class="filters">
      <label for="categoria">Filtrar por categoría:</label>
      <select id="categoria" onchange="filtrarProductos()">
        <option value="todos">Todos</option>
        <option value="celular">Celulares</option>
        <option value="electronico">Electrónicos</option>
        <option value="joya">Joyas</option>
        <option value="reloj">Relojes</option>
        <option value="diamante">Diamantes</option>
        <option value="moneda">Moneda</option>
        <option value="herramienta">Herramientas</option>
      </select>
    </div>

    <!-- Listado de productos -->
    <div class="product-list" id="product-list">
      <!-- Los productos serán generados dinámicamente aquí -->
    </div>

    <script>
      let productos = [];

      // Cargar productos disponibles para la compra
      async function cargarProductos() {
        try {
          const response = await fetch("/productos-en-venta");
          productos = await response.json();
          console.log(productos); // Verifica si llegan los productos
          mostrarProductos(productos);
        } catch (error) {
          console.error("Error al cargar los productos:", error);
        }
      }

      // Mostrar productos en la interfaz
      function mostrarProductos(productos) {
        const productList = document.getElementById("product-list");
        productList.innerHTML = ""; // Limpiar la lista antes de mostrar

        productos.forEach((producto) => {
          productList.innerHTML += `
            <div class="product-card">
                <img src="${producto.foto}" alt="Imagen de ${producto.descripcion}">
                <h3>${producto.descripcion}</h3>
                <p><strong>Categoría:</strong> ${producto.categoria}</p>
                <p class="price">Q${producto.precio}</p>
                <button onclick="comprarProducto('${producto._id}')">Comprar</button>
            </div>
        `;
        });
      }

      // Filtrar productos por categoría
      function filtrarProductos() {
        const categoria = document.getElementById("categoria").value;
        const productosFiltrados =
          categoria === "todos"
            ? productos
            : productos.filter((producto) => producto.categoria === categoria);
        mostrarProductos(productosFiltrados);
      }

      // Función para comprar un producto
      async function comprarProducto(productoId) {
        try {
          const response = await fetch(`/comprar-producto/${productoId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (response.ok) {
            alert(result.message);
            cargarProductos(); // Recargar la lista de productos para que el comprado no se muestre más
          } else {
            alert("Error al comprar el producto");
          }
        } catch (error) {
          console.error("Error al comprar el producto:", error);
        }
      }

      // Cargar productos cuando la página se cargue
      window.onload = cargarProductos;

      // Función para cerrar sesión
      async function cerrarSesion() {
        try {
          const response = await fetch("/auth/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            window.location.href = "/login.html";
          } else {
            alert("Error al cerrar sesión");
          }
        } catch (error) {
          console.error("Error al cerrar sesión:", error);
        }
      }
    </script>
    <script>
      async function verificarPrestamosVencidos() {
        try {
          const response = await fetch("/verificar-prestamos-vencidos", {
            method: "POST",
          });
          const result = await response.json();
          alert(result.message);
        } catch (error) {
          console.error("Error al verificar préstamos vencidos:", error);
        }
      }
    </script>
  </body>
</html>
